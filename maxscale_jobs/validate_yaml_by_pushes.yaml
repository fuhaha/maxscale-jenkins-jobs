- job:
    name: validate_yaml_by_pushes
    description: 'This job check maxscale-jobs repo content using validator triggered by pushes.'
    triggers:
      - github
    scm:
      - git:
          url: 'git@github.com:mariadb-corporation/maxscale-jenkins-jobs.git'
          branches:
            - '*'
    builders:
      - shell: |
          prop_file="failed_yaml_tests_property_file"
          injection_var="FAILED_YAML_TESTS_LIST"

          jobs=`ls maxscale_jobs/*.yaml -1`
          res=0
          failed_list=""

          for job in $jobs
          do
            
            if $HOME/jjg/scripts/validate_yaml.sh $job ; then
              echo "Validating of $job SUCCESS."
            else
              echo "Validating of $job FAILED!"
              failed_list="$failed_list \n $job"

              echo "$job \\" >> "$prop_file"

              res=1
            fi
          done

          if [ $res != 0 ]; then
            echo ""
            echo "Failed jobs:"
            echo -e $failed_list
          fi

          prop_file_content=$(cat "$prop_file")
          if [[ -n "$prop_file_content" ]]; then
            echo "$injection_var=Failed yaml jobs: \\$prop_file_content" > "$prop_file"
          fi

          exit $res
    publishers:
      - !include: './maxscale_jobs/include/mail_yaml.yaml'
