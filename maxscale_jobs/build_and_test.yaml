- job:
    name: build_and_test
    description: 'This job builds Maxscale and runs tests'
    parameters: 
      - string:
          name: name
          default: !include: './maxscale_jobs/include/default_run_test_name.yaml'
      - !include: './maxscale_jobs/include/value.yaml'
      - !include: './maxscale_jobs/include/source.yaml'
      - choice:
          name: box
          choices:
            !include: './maxscale_jobs/include/boxes.yaml'
      - !include: './maxscale_jobs/include/remove_strip.yaml'
      - !include: './maxscale_jobs/include/cmake_flags.yaml'
      - !include: './maxscale_jobs/include/do_not_destroy_vm.yaml'
      - string:
          name: test_set
          default: !include: './maxscale_jobs/include/default_test_set.yaml'
      - string:
          name: ci_url
          default: !include: './maxscale_jobs/include/default_ci_url.yaml'
      - string:
          name: repo_user
          default: ''
      - string:
          name: repo_password
          default: ''
      - choice:
          name: smoke
          choices:
              - 'yes'
              - 'no'
      - choice:
          name: big
          choices:
              - 'no'
              - 'yes'
      - choice:
          name: ci_release
          choices:
              - ci
              - release
    scm:
      - git:
          url: !include './maxscale_jobs/include/maxscale_repo.yaml'
          branches:
            - master
    builders:
        - !include: './maxscale_jobs/include/build_parser/create_env_vars_build_and_test.yaml'
        - !include: './maxscale_jobs/include/build_parser/inject_initial_env.yaml'
        - shell:
            '~/build-scripts/prepare_and_build.sh'
        - !include: './maxscale_jobs/include/build_parser/run_test_and_collect.yaml'
        - !include: './maxscale_jobs/include/build_parser/parse_build_log.yaml'
        - !include: './maxscale_jobs/include/build_parser/write_build_results.yaml'
        - !include: './maxscale_jobs/include/build_parser/inject_build_results.yaml'
    publishers:
      - !include: './maxscale_jobs/include/build_parser_mail.yaml'
    wrappers:
      - !include: './maxscale_jobs/include/workspace-cleanup.yaml'
    concurrent: true
